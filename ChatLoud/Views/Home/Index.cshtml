@{
    ViewBag.Title = "Home Page";
    

}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - Chat Loud</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")

</head>
<body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                @Html.ActionLink("Chat Loud", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li>@Html.ActionLink("Home", "Index", "Home")</li>
                    <li>@Html.ActionLink("About", "About", "Home")</li>
                    <li>@Html.ActionLink("Contact", "Contact", "Home")</li>
                </ul>
                <ul class="nav navbar-nav">
                    <li class="livesearchli">
                        <input type="text" class="searchtext" id="searchtext" placeholder="Search Friends..." />
                        <ul id="livesearchul"></ul>
                    </li>
                </ul>
                @Html.Partial("_LoginPartial")
            </div>
        </div>
    </div>
    <div class="container body-content">


        <div class="row">
            <div class="col-md-4">
                <h2>Getting started</h2>
            </div>
        </div>

        <div class="chat @User.Identity.Name">
            <ul></ul>
        </div>
    </div>

    <div class="chatboxholder" id="chb@(User.Identity.Name)"></div>
    <div class="chatbox">
        <h4><span></span></h4>
        <div class="chatboxtext"></div>
        <textarea class="chattextarea"></textarea>
        <br />
        <a href="#" class="sendchat">send</a>
    </div>

    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    <script src="~/Scripts/jquery.signalR-2.2.3.min.js"></script>
    <script src="/signalr/hubs"></script>

    <script>
        $(document).ready(function () {
            console.log("hello");
            $("input#searchtext").keyup(function () {
                var url = "/Profile/LiveSearch"
                var searchVal = $("input#searchtext").val();

                console.log(url);

                $("ul#livesearchul").empty();

                if (searchVal == "" || searchVal.trim() == "") return false;

                $.post(url, { searchVal: searchVal }, function (data) {
                    if (data.length > 0) {
                        $("ul#livesearchul").append("<li id=close class=close><a>x</a></li>");
                    }
                    for (var i = 0; i < data.length; i++) {
                        var obj = data[i];
                        $("ul#livesearchul").append("<li class=livesearchli><a href='/Profile/Index/" + obj.Id + "'>" + obj.UserName + "</a></li>");
                    }
                });
                $("body").on("click", "ul#livesearchul li.close", function () {
                    console.log("clicked");
                    $("ul#livesearchul").empty();
                    $("input#searchtext").val("");
                });
            });
            var hub = $.connection.echo;
            console.log(hub);

            hub.client.test = function (msg) {
                console.log(">>>>>>>>>>" + msg);
            };
            hub.client.getonlineusers = function (user, data) {
                console.log("Data is:", JSON.parse(data));
                var result = JSON.parse(data);

                for (var i = 0; i < result.length; i++) {
                    var obj = result[i];
                    console.log("obj", obj)
                    $(".chat." + user + "> ul").append('<li class="cf' + obj.id + '" data-id="' + obj.id + '">' + obj.friend + '</li>');

                    var chatbox = $("body > .chatbox").clone();

                    chatbox.attr("data-id", obj.id);
                    chatbox.attr("id", "cb" + obj.id);
                    chatbox.addClass("hidden");

                    chatbox.find("a.sendchat").attr("data-friend", obj.friend);
                    chatbox.find("a.sendchat").attr("data-id", obj.id);
                    chatbox.find("div.chatboxtext").attr("id", "cbtext" + obj.id);
                    $("#chb" + user).append(chatbox);
                    //$("#chb " + user + " #cb" + obj.id + " h4 > span").html('<img src="uploads/' + obj.id + '.jpg" />');

                }

            }
            hub.client.updatechat = function (user, data) {
                var result = JSON.parse(data);

                $(".chat." + user + "> ul").empty();
                for (var i = 0; i < result.length; i++) {
                    var obj = result[i];

                    $(".chat." + user + "> ul").append('<li class="cf' + obj.id + '" data-id="' + obj.id + '">' + obj.friend + '</li>');

                    if (!($(".chatboxholder #cb" + obj.id).length)) {
                        var chatbox = $("body > .chatbox").clone();

                        chatbox.attr("data-id", obj.id);
                        chatbox.attr("id", "cb" + obj.id);
                        chatbox.addClass("hidden");
                        

                        chatbox.find("a.sendchat").attr("data-friend", obj.friend);
                        chatbox.find("a.sendchat").attr("data-id", obj.id);
                        chatbox.find("div.chatboxtext").attr("id", "cbtext" + obj.id);

                        $("#chb" + user).append(chatbox);
                        //$("#chb" + user + " #cb" + obj.id + " h4 > span").html('<img src="uploads/' + obj.id + '.jpg" />');

                    }

                }

            }
            hub.client.sendchat = function (userId, user, friendId, friendUsername, message) {
                console.log(user, friendUsername)
                var date = new Date();
                var a = $("#chb" + user + " div#cb" + friendId + " .chatboxtext");
                a.append("<span>" + user + ": " + message + "</span><br />");
                a.append("<h6><small>" + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds()+"</small></h6>")

                a.scrollTop(a.prop("scrollHeight"));

                if ($("#chb" + friendUsername + " div#cb" + userId).hasClass("hidden")) {
                    $('li.cf' + userId).addClass("msg");
                }

                var b = $("#chb" + friendUsername + " div#cb" + userId + " .chatboxtext");
                b.append("<span class='pull-right'>" + user + ": " + message + "</span><br />");
                b.scrollTop(b.prop("scrollHeight"));
            }


            $.connection.hub
                .start()
                .done(function () {

                    console.log("I am in here");
                    hub.server.hello("Signalr working");

                });

            $("body").on("click", ".chat ul li", function () {

                var $this = $(this);

                if ($this.hasClass("msg")) $this.removeClass("msg");

                var friend = $this.text().trim();

                var chatboxNumber = $(".chatboxholder .chatbox:not(.hidden)").length;

                var id = $this.data("id");

                var right = 320;

                var cb = $(".chatboxholder #cb" + id);

                if (!cb.length) {
                    cb.css("right", right * chatboxNumber);
                } else if (cb.hasClass("hidden")) {
                    cb.removeClass("hidden");
                    cb.css("right", right * chatboxNumber);
                } else {
                    cb.addClass("hidden");
                    cb.css("right", right * chatboxNumber);
                }

            });

            $("body").on("keypress", ".chatbox textarea", function (e) {

                if (e.which == 13) {
                    $(this).parent().find("a.sendchat").click();
                    setTimeout(function () {
                        $(this).parent().find("textarea").focus();

                    }, 0);
                }

            });

            /*
            / Display unread messages

            */

            $("body").on("click", "a.sendchat", function (e) {
                e.preventDefault();

                console.log("sent pressed")

                var $this = $(this);

                var friendId = $this.data("id");
                var friendUsername = $this.data("friend");
                var message = $this.parent().find("textarea").val();

                $this.parent().find("textarea").val("");

                hub.server.sendChat(friendId, friendUsername, message);

            });


        });


    </script>
</body>
</html>




